
import sys
import os
from pathlib import Path

# Add backend to sys.path
sys.path.append(str(Path(__file__).parent.parent))

from src.analysis.quality_analyzer import QualityAnalyzer
from src.core.metrics import StructuralMetrics
from src.analysis.models import StructuralAnalysisResult
from src.core.layers import AnalysisLayer
from src.analysis.weight_calculator import QualityWeights

def test_vulnerability_orthogonality():
    # 1. Create two components: A and B
    # A has high out-degree, B has zero out-degree.
    # Both have the same EV and CL.
    # V(A) and V(B) should now be IDENTICAL.
    
    comp_a = StructuralMetrics(id="A", name="AppA", type="app", eigenvector=0.5, closeness=0.5, out_degree_raw=100)
    comp_b = StructuralMetrics(id="B", name="AppB", type="app", eigenvector=0.5, closeness=0.5, out_degree_raw=0)
    
    # Mock result
    result = StructuralAnalysisResult(
        layer=AnalysisLayer.APP,
        components={"A": comp_a, "B": comp_b},
        edges={},
        graph_summary=None
    )
    
    # Initialize analyzer with manual weights (ensure v_out_degree is ignored)
    weights = QualityWeights(
        v_eigenvector=0.67,
        v_closeness=0.33,
        v_out_degree=0.5,  # Even if this is set manually, the formula should ignore it
        m_out_degree=1.0    # Maintainability SHOULD still be affected
    )
    
    analyzer = QualityAnalyzer(weights=weights, use_ahp=False, normalization_method="max")
    quality_result = analyzer.analyze(result)
    
    qa = next(c for c in quality_result.components if c.id == "A")
    qb = next(c for c in quality_result.components if c.id == "B")
    
    print(f"App A: OD={qa.structural.out_degree_raw}, V={qa.scores.vulnerability:.4f}, M={qa.scores.maintainability:.4f}")
    print(f"App B: OD={qb.structural.out_degree_raw}, V={qb.scores.vulnerability:.4f}, M={qb.scores.maintainability:.4f}")
    
    # V scores should be identical (both derive from EV=0.5, CL=0.5)
    assert abs(qa.scores.vulnerability - qb.scores.vulnerability) < 1e-6, "Vulnerability scores should be identical regardless of out-degree"
    
    # M scores should be different (A has higher out-degree)
    assert qa.scores.maintainability > qb.scores.maintainability, "Maintainability should still capture out-degree impact"
    
    print("\nVulnerability Orthogonality test passed!")

if __name__ == "__main__":
    test_vulnerability_orthogonality()
